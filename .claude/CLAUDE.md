# ベンフォードの法則チェックアプリ

Rustで作るCLIアプリケーション。数値データがベンフォードの法則に従っているかをチェックする。

## 機能要件
- パイプからの文字列入力に対応
- 引数で与えた文字列に対応  
- URLを指定してWebサイトのデータを解析
- ファイル入力（多様なフォーマット対応）
- HTMLタグを除外して数値のみを抽出する独自機能

## 技術仕様
- 言語: Rust
- 入力方式: 
  - stdin (パイプ)
  - コマンドライン引数（文字列データ）
  - ファイルパス引数（Excel/PDF/Word等）
  - URL引数（HTTP/HTTPS）
  - **優先順位**: URL > ファイル > 文字列 > パイプ (複数指定時)
- HTML解析: 独自実装またはクレート使用
- 数値抽出: 正規表現ベース
- 出力形式: 
  - デフォルト: 人間可読テキスト + ASCII グラフ (標準出力)
  - --format オプション: csv, json, yaml, toml, xml (標準出力)
  - --quiet: 数値結果のみ
  - --verbose: 詳細統計情報付き
  - ファイル保存: リダイレクト使用 (例: benf data.csv --format json > result.json)

## 競合分析と独自性
- 既存のベンフォード法則CLIツールは英語圏作成
- **独自性**：日本語数字への対応
  - 全角数字（０１２３４５６７８９）
  - 漢数字（一二三四五六七八九十百千万）
  - 混在パターンの処理
- 既存ツールの機能を同等以上に実装
- 競合の予定機能も先行実装
- GUI版機能のCUI擬似再現

## 開発メモ
- 独自にURL引数でHTTP取得する方式が良い理由：
  - HTMLタグを除外して数値のみ抽出可能
  - パイプ経由よりも使いやすい
  - エラーハンドリングが統一できる
- 数値の先頭桁の分布を計算してベンフォードの法則と比較
- ベンフォードの法則の理論値：
  - 1が先頭: 30.1%
  - 2が先頭: 17.6%
  - 3が先頭: 12.5%
  - ...9が先頭: 4.6%
- 統計的な適合度テスト（カイ二乗検定など）
- 一致度指標の実装（既存ツール互換）
- 使用予定クレート: 
  - reqwest (HTTP通信)
  - scraper (HTML解析)
  - calamine (Excel読み込み)
  - pdf-extract (PDF解析)
  - docx-rs (Word解析)
- 日本語数字変換ロジック実装必要
- **重要**: 数値サンプル数が少ない場合の警告表示
- **重要**: 負数・小数の扱い方針を明確化
- **重要**: エラーハンドリング - ファイル読み込み失敗、ネットワーク障害
- **重要**: パフォーマンス - 大容量ファイル処理時のメモリ管理
- **重要**: セキュリティ - 悪意あるURL/ファイルの処理制限
- **重要**: コマンドライン引数設計 - 文字列 vs ファイルパス vs URL の自動判別ロジック
- **重要**: 終了コード設計 - 成功/警告/エラー/異常検知の区別
- **重要**: ヘルプ・バージョン表示 (--help, --version, -h, -V)
  - バージョン情報にビルド日時・commit hash含める
  - 作者名はREADME/ライセンスのみ、CLI出力には含めない
- **重要**: ログレベル設定 (--log-level debug/info/warn/error)
- **致命的**: ゼロで始まる数値の扱い (001, 0.5等) - ベンフォード法則対象外
- **致命的**: 設定ファイルの場所とフォーマット決定 ※シンプル化のため削除検討
- **致命的**: 国際化対応 (i18n) - エラーメッセージの多言語化
- **致命的**: テストデータセット同梱の是非
- **致命的**: ドキュメント・マニュアル生成方法
  - README.md (英語): インストール・基本使用法・サンプル
  - README_ja.md (日本語): 日本語数字対応の詳細説明
  - man page: 詳細オプション説明  
  - CHANGELOG.md: バージョン履歴
  - **先行作成**: 実装前にREADMEで仕様確定・API設計検証
- **致命的**: クロスプラットフォーム対応 (Windows/macOS/Linux)
- **致命的**: 依存関係のバージョン管理とセキュリティ更新ポリシー
- **致命的**: 引数なし実行時の動作 - 自動ヘルプ表示 vs エラー vs stdin待機
- **致命的**: 進捗表示とキャンセル処理 (Ctrl+C対応)
- **致命的**: 一時ファイル管理とクリーンアップ処理
- **致命的**: メモリ使用量制限とOOM対策
- **致命的**: 文字エンコーディング対応 (UTF-8/Shift_JIS/EUC-JP)
- **致命的**: 数値精度とオーバーフロー処理
- **致命的**: 設定の優先順位 (CLI引数 > デフォルト) ※シンプル化
- **致命的**: プロキシ対応 - HTTP_PROXY/HTTPS_PROXY環境変数 + --proxy オプション
- **致命的**: SSL/TLS証明書検証 - OSの証明書ストア利用 vs 独自CA証明書対応
- **致命的**: 自己署名証明書 - --insecure オプションで検証スキップ可能にするか
- **致命的**: ログ出力設計 - OSデフォルトログ場所 vs ログなし vs syslog連携
  - Linux: /var/log/ または ~/.local/state/
  - macOS: ~/Library/Logs/
  - Windows: %APPDATA%/Logs/
  - **重要**: ログは標準出力に出さない（パイプ処理妨害防止）
- **超致命的**: タイムアウト設定 - URL/大容量ファイル処理の無限待機防止
- **超致命的**: リトライ制御 - ネットワーク一時障害対応
- **超致命的**: 同時接続数制限 - 複数URL処理時のサーバー負荷対策
- **超致命的**: User-Agent設定 - サーバーからのブロック回避
- **超致命的**: レート制限対応 - API制限やDDoS防止対策
- **超致命的**: リダイレクト処理 - HTTP 301/302の追跡制限
- **超致命的**: Content-Type検証 - HTMLでないコンテンツの処理方針
- **超致命的**: バイナリファイル判定 - 処理対象外ファイルのスキップ

## 機能提案
### 既存ツール標準機能
- 棒グラフ・ヒストグラム出力（ASCII art）
- CSV/JSON/YAML/TOML形式での結果出力
- 複数ファイル・URL一括処理
- 信頼区間表示
- p値計算
- 詳細統計情報（平均絶対偏差など）

### 不正検知特化機能
- **異常検知**: 法則から大きく逸脱した時点でアラート
  - 危険度レベル表示 (LOW/MEDIUM/HIGH/CRITICAL)
  - 警告・エラーは標準エラー出力 (stderr) に出力
  - 危険度は結果データに含める
  - 閾値カスタマイズ可能
- **ライブモニタリング**: `tail -f` のようにリアルタイムでデータ監視
- **比較モード**: 複数データセットの法則適合度比較
- **フィルタリング**: 特定範囲の数値のみ解析（例：100以上）
- **不正検知対象フォーマット**:
  - Excel (.xlsx, .xls) - 会計データ、売上レポート
  - PDF - 財務諸表、監査報告書、申告書
  - HTML - Webレポート、オンライン申請
  - Word (.docx, .doc) - 報告書、稟議書
  - PowerPoint (.pptx, .ppt) - プレゼン資料の数値
  - OpenDocument (.ods, .odt) - オープンオフィス文書
  - 画像 (OCR) - スキャンした帳票、領収書 ※将来機能
  - CSV/TSV - データエクスポート
  - JSON/XML - API レスポンス、システムログ
  - YAML/TOML - 設定ファイル、データ定義
- **並列処理**: マルチスレッドでの高速解析

## パイプライン活用例
### 監視・自動化
- `benf --url API_ENDPOINT --format json | jq '.p_value < 0.05'`
- `tail -f access.log | benf --format json | jq 'select(.risk_level == "HIGH")'`
- `crontab: benf sales.csv --format json | mail -s "Daily Fraud Check"`

### データ処理チェーン
- `benf data.csv --format json | jq '.digits[0]' | gnuplot`
- `benf --quiet | awk '{if($1<0.5) print "suspicious"}' | tee report.txt`
- `find . -name "*.csv" -exec benf {} \; | sort -k2 -n`

### 統計分析パイプライン
- `benf data | R --slave -e "summary(scan())"`
- `benf --format csv | python analysis.py | benf` (二次解析)
- `benf | fzf --preview "echo 'Score: {}'"` (インタラクティブ選択)

## 実用的メリット・応用例
### 不正検知・監査
- **会計監査**: 売上データ・経費データの人為的操作検出
- **税務調査**: 申告書数値の不自然な偏りを発見
- **選挙監視**: 投票数・得票率の改ざん疑惑検証
- **保険査定**: 保険金請求額の詐欺パターン検出

### データ品質管理
- **システム障害検知**: ログデータの異常パターン発見
- **センサー故障**: IoTデバイスの測定値異常検出
- **APIレスポンス**: 外部サービスのデータ品質監視
- **データベース整合性**: バックアップ・レプリケーション検証

### 研究・分析支援
- **科学データ検証**: 実験結果の信頼性評価
- **マーケット分析**: 株価・取引量の自然性確認
- **人口統計**: 国勢調査データの妥当性検証
- **ソーシャル分析**: SNS投稿数・いいね数の真正性判定

### リスク管理
- **金融リスク**: 取引パターンの異常検知
- **サイバーセキュリティ**: 攻撃トラフィックの識別
- **品質管理**: 製造データの工程異常発見

## 実装段取り（TDD）

### フェーズ1: コア機能のテスト設計
1. **テスト構造設計**
   - tests/unit/ - 単体テスト
   - tests/integration/ - 統合テスト  
   - tests/fixtures/ - テストデータ
   - tests/common/mod.rs - 共通テストユーティリティ

2. **コア関数のテストケース作成**
   ```rust
   // 数値抽出
   fn extract_numbers(text: &str) -> Vec<f64>
   fn convert_japanese_numerals(text: &str) -> String
   
   // ベンフォード解析
   fn calculate_benford_distribution(numbers: &[f64]) -> BenfordResult
   fn calculate_chi_square(observed: &[f64], expected: &[f64]) -> (f64, f64)
   fn determine_risk_level(p_value: f64) -> RiskLevel
   
   // 入力処理
   fn read_from_stdin() -> Result<String>
   fn fetch_from_url(url: &str, options: &NetworkOptions) -> Result<String>
   fn parse_file(path: &Path) -> Result<String>
   
   // 出力処理
   fn format_output(result: &BenfordResult, format: OutputFormat) -> String
   ```

3. **テストデータ準備**
   - 日本語数字サンプル（全角・漢数字・混在）
   - ベンフォード法則に従うデータセット
   - 不正を模した偏ったデータセット
   - エラーケース（不正なURL、壊れたファイル等）

### フェーズ2: 基本構造実装
1. **プロジェクト構造**
   ```
   src/
   ├── main.rs              # エントリポイント
   ├── lib.rs               # ライブラリルート
   ├── cli.rs               # CLI引数解析（clap）
   ├── core/
   │   ├── mod.rs
   │   ├── benford.rs       # ベンフォード法則計算
   │   ├── japanese.rs      # 日本語数字変換
   │   └── statistics.rs    # 統計計算
   ├── input/
   │   ├── mod.rs
   │   ├── parser.rs        # ファイル形式判定・解析
   │   ├── network.rs       # HTTP取得
   │   └── formats/         # 各ファイル形式パーサー
   │       ├── excel.rs
   │       ├── pdf.rs
   │       └── ...
   ├── output/
   │   ├── mod.rs
   │   ├── formatter.rs     # 出力フォーマット
   │   └── display.rs       # ASCII グラフ生成
   └── error.rs             # エラー型定義
   ```

2. **基本型定義**
   ```rust
   #[derive(Debug, Clone)]
   pub struct BenfordResult {
       pub dataset_name: String,
       pub numbers_analyzed: usize,
       pub digit_distribution: [f64; 9],
       pub chi_square: f64,
       pub p_value: f64,
       pub risk_level: RiskLevel,
   }
   
   #[derive(Debug, Clone, PartialEq)]
   pub enum RiskLevel {
       Low,    // p > 0.1
       Medium, // 0.05 < p ≤ 0.1  
       High,   // 0.01 < p ≤ 0.05
       Critical, // p ≤ 0.01
   }
   ```

### フェーズ3: コア機能実装
1. **日本語数字変換** (最重要・独自機能)
   - 全角数字 → 半角数字
   - 漢数字 → アラビア数字（位取り記法対応）
   - 混在パターン処理

2. **ベンフォード法則計算**
   - 先頭桁分布計算
   - カイ二乗検定
   - p値計算・リスク判定

3. **数値抽出**
   - 正規表現ベース抽出
   - ゼロ始まり・小数・負数の処理

### フェーズ4: 入力処理実装
1. **基本入力**
   - stdin（パイプ）
   - コマンドライン引数
   - テキストファイル

2. **ネットワーク機能**
   - HTTP/HTTPS取得
   - プロキシ対応
   - SSL証明書処理
   - タイムアウト・リトライ

3. **ファイル形式対応**
   - Excel (.xlsx, .xls)
   - PDF (.pdf)
   - Word (.docx, .doc)
   - 構造化データ (CSV, JSON, XML)

### フェーズ5: 出力・CLI実装
1. **出力フォーマット**
   - 人間可読テキスト + ASCII グラフ
   - JSON/CSV/YAML/TOML/XML

2. **CLI インターフェース**
   - 引数解析（clap使用）
   - ヘルプ・バージョン表示
   - エラーハンドリング

3. **ログ・設定**
   - 構造化ログ（log + env_logger）
   - OS別ログファイル配置

### フェーズ6: 高度機能・最適化
1. **性能改善**
   - 並列処理（tokio）
   - メモリ効率化
   - 大容量ファイル対応

2. **監視・自動化機能**
   - ライブモニタリング
   - 異常検知アラート
   - 比較・フィルタリング

3. **品質保証**
   - 統合テスト拡充
   - パフォーマンステスト
   - セキュリティテスト

### 各フェーズの完了条件
- **フェーズ1**: 全テストケース作成・実行（Red）
- **フェーズ2**: 基本構造コンパイル成功
- **フェーズ3**: コア機能テスト通過（Green）
- **フェーズ4**: 基本CLI動作確認
- **フェーズ5**: 全機能テスト通過
- **フェーズ6**: 性能・品質目標達成

### 次の作業
1. テスト構造作成 ✅ 完了
2. 日本語数字変換のテストケース作成 ✅ 完了
3. ベンフォード計算のテストケース作成 ✅ 完了

## 進捗記録

### フェーズ1: テスト設計 ✅ **完了** (2025-07-01)

#### 完了したタスク
- ✅ **テスト構造設計完了**
  - tests/unit/ - 単体テスト
  - tests/integration/ - 統合テスト
  - tests/fixtures/ - テストデータ
  - tests/common/ - 共通ユーティリティ

- ✅ **包括的テストケース作成**
  - japanese_numerals.rs - 日本語数字変換テスト (94テストケース)
  - benford_calculations.rs - ベンフォード法則計算テスト (85テストケース)
  - number_extraction.rs - 数値抽出テスト (67テストケース)
  - risk_assessment.rs - リスク評価テスト (78テストケース)
  - cli_tests.rs - CLI統合テスト (45テストケース)

- ✅ **テストフィクスチャ・データ完備**
  - CSV, JSON, YAML, TOML形式のサンプルデータ
  - OpenDocument (.ods, .odt) ファイル
  - 日本語数字テストケース (全角・漢数字・混在)
  - ベンフォード法則準拠/逸脱データセット
  - 不正検知シナリオデータ

- ✅ **仕様整合性確認・修正**
  - README.md/README.ja.md の対応フォーマット整理
  - Microsoft製品のグループ化
  - --insecure オプション明記
  - OpenDocument形式対応追加
  - YAML/TOML入力対応確認

#### テスト网羅範囲
- **日本語数字変換**: 全角数字、漢数字、位取り記法、混在パターン
- **ベンフォード計算**: 分布計算、カイ二乗検定、p値、リスク判定
- **数値抽出**: 正規表現、エッジケース、フィルタリング
- **リスク評価**: 4段階リスク、信頼度、データ品質評価
- **CLI統合**: 全オプション、ファイル形式、エラーハンドリング

#### 重要な仕様追加 (2025-07-01)
- ✅ **適用限界の明記**: README/README.ja.mdに追加
  - 制約のある範囲データ（身長、年齢等）は対象外
  - 連番・割り当て番号は対象外
  - 小規模・単一ソース・丸め込みデータは不適切
  - 適用条件の明確化で誤用防止

### フェーズ2: 基本構造実装 🚧 **進行中** (2025-07-01)

#### 完了したタスク
- ✅ **プロジェクト構造作成**
  - src/main.rs - エントリポイント作成
  - src/lib.rs - ライブラリルート設定
  - src/core/, src/input/, src/output/ - モジュール構造構築

- ✅ **基本型定義完了**
  - BenfordResult構造体 - 解析結果格納
  - RiskLevel enum - 4段階リスク評価 (Low/Medium/High/Critical)
  - BenfError enum - エラーハンドリング体系
  - 終了コード設計 (0/10/11対応)

- ✅ **コア機能実装**
  - 日本語数字変換 (convert_japanese_numerals)
    - 全角数字→半角数字変換
    - 漢数字→アラビア数字変換（位取り記法対応）
    - 混在パターン処理
  - ベンフォード法則計算 (calculate_digit_distribution)
    - 先頭桁分布計算
    - 期待値との比較
  - 統計計算 (calculate_chi_square, calculate_p_value, calculate_mad)
    - カイ二乗検定
    - p値計算
    - 平均絶対偏差
  - 数値抽出 (extract_numbers)
    - 正規表現ベース抽出
    - 日本語数字前処理統合
  - 出力フォーマット (format_output)
    - テキスト/JSON形式対応
    - ASCII棒グラフ生成

#### TDD進捗状況
- **Red→Green遷移**: 部分的に成功
  - ✅ 全角数字変換テスト: 通過
  - ✅ 混在パターンテスト: 通過
  - ❌ 漢数字変換テスト: 失敗 (位取り記法ロジック要修正)
  - 📊 **テスト通過率**: 2/3 (66.7%)

#### 判明した課題
- **漢数字変換ロジック**: "一千二百三十四" → "1000200304" (期待値: "1234")
  - 位取り記法の処理順序要見直し
  - プレースホルダーゼロの処理改善必要

#### 次のステップ  
- 漢数字変換ロジック修正
- 全コアテスト通過確認
- フェーズ3: CLI インターフェース実装準備